# **“土豆食堂”项目阿里云服务器生产环境部署手册**

本文档将指导您如何将 “土豆食堂” (Lynx) Laravel 项目成功部署到阿里云 Ubuntu 24.04 服务器上，并配置 wkarrow.top 域名及自动续期的 Let's Encrypt SSL 证书，实现安全的 HTTPS 访问。

**部署信息:**

* **云服务器:** 阿里云 Ubuntu Server 24.04  
* **公网 IP:** 123.57.128.170  
* **根域名:** wkarrow.top  
* **应用子域名:** lynx.wkarrow.top (我们将使用此子域名作为示例)  
* **核心工具:** Docker Engine, Nginx Proxy Manager

## **第一阶段：域名解析与服务器准备**

### **步骤 1：初始化服务器系统**

1. 准备一台新的阿里云服务器，或对现有服务器重装系统，选择 **Ubuntu 24.04**。  
2. 配置服务器的 root 密码。  
3. 通过 SSH 客户端（如 Xshell）登录到您的服务器。  
4. 执行系统更新，确保所有基础软件都是最新版本： 
   ```sh
   sudo apt update  
   sudo apt upgrade -y
   ```

### **步骤 2：安装 Docker Engine (国内服务器优化)**

我们将使用阿里云的镜像源来加速 Docker Engine 的安装过程。

1. 添加阿里云镜像站的 Docker GPG 密钥
   ```sh 
   sudo apt-get install ca-certificates curl -y 
   
   sudo install -m 0755 -d /etc/apt/keyrings  

   sudo curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg  

   sudo chmod a+r /etc/apt/keyrings/docker.gpg
   ```

2. 添加阿里云的 Docker APT 软件源
   此命令会自动检测您的系统版本并创建正确的软件源配置文件。  
   ```sh
   echo   
     "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu   
     $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" |   
     sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
   ```
3. 更新软件源索引并安装 Docker
   ```sh
   sudo apt-get update  
   sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y

   # 此命令会一并安装 Docker 引擎、命令行工具、containerd 以及 Docker Compose 插件。
   ```  
4. 验证安装
   运行以下命令，如果能看到版本号，则说明 Docker 和 Docker Compose 都已成功安装。  
   ```sh
   docker --version  
   docker compose version
   ```

### **步骤 3：配置 Docker Hub 加速镜像**

为了加速后续拉取 Docker 镜像的速度，我们需要配置镜像加速器。

1. 创建或修改 Docker 的配置文件： 
   ```sh
   sudo mkdir -p /etc/docker  
   sudo vim /etc/docker/daemon.json
   ```

2. 将以下 JSON 内容复制并粘贴到文件中：
   ```json
   {  
     "registry-mirrors": [  
       "https://u8uqbcma.mirror.aliyuncs.com",  
       "https://docker.m.daocloud.io",  
       "https://hub-mirror.c.163.com",  
       "https://mirror.baidubce.com",  
       "https://ccr.ccs.tencentyun.com"  
     ]  
   }
   
3. 保存并退出 (Ctrl+X, Y, Enter)。

4. 重启 Docker 服务以使配置生效：  
   ```sh
   sudo systemctl daemon-reload  
   sudo systemctl restart docker
   ```

### **步骤 4：配置域名与安全组**

1. **域名解析**：确保您的子域名 lynx.wkarrow.top 已经创建了 A 记录，指向您服务器的公网 IP 123.57.128.170。  
2. **安全组放行**：确保阿里云服务器的安全组已放行 80, 443, 和 81 端口的入站流量。

## **第二阶段：部署 Nginx Proxy Manager (NPM)**

1. 在服务器上，为 NPM 创建一个专用的工作目录：  
   ```sh
   sudo mkdir -p /opt/npm/data  
   sudo mkdir /opt/npm/letsencrypt
   ```

2. 进入该目录并创建一个 docker-compose.yml 文件：
   ```sh
   cd /opt/npm  
   sudo vim docker-compose.yml
   ```

3. 将以下内容复制并粘贴到这个新文件中，然后保存退出：
   ```yaml
   services:
     app:
       image: 'jc21/nginx-proxy-manager:latest'
       restart: unless-stopped
       ports:
         # These ports are in format <host-port>:<container-port>
         - '80:80' # Public HTTP Port
         - '443:443' # Public HTTPS Port
         - '81:81' # Admin Web Port
       volumes:
         - ./data:/data
         - ./letsencrypt:/etc/letsencrypt
       networks:
         - npm_default

   networks:
     npm_default:
       name: npm_default
   ```  
4. 启动 Nginx Proxy Manager:  
   ```sh
   sudo docker compose up -d
   ```
5. **初始化 NPM**：  
   * 打开浏览器，访问 http://123.57.128.170:81。  
   * 使用默认账户首次登录 (Email: admin@example.com, Password: changeme)，并立即修改密码。

## **第三阶段：在服务器上部署项目**

### **步骤 1：获取项目代码**

1. 在服务器上，选择一个位置存放您的项目代码，例如 /var/www：  
   ```sh
   sudo mkdir -p /var/www  
   cd /var/www
   ```

2. 从您的 Git 仓库克隆项目代码：  
   ```sh
   sudo git clone https://github.com/NightingaleWK/lynx.git
   cd lynx
   ```

### **步骤 2：创建并配置 .env 文件**

1. 复制示例文件：  
   ```sh
   sudo cp .env.example .env
   ```

2. 编辑 .env 文件： 
   ```sh
   sudo vim .env
   ```

3. **进行以下关键修改**： 
   ```env
   APP_NAME=Lynx  
   APP_ENV=production  
   APP_DEBUG=false  
   APP_URL=https://lynx.wkarrow.top

   # 留空，后续命令生成  
   APP_KEY=

   DB_CONNECTION=mysql  
   # 必须是 docker-compose.internet.yml 中定义的服务名  
   DB_HOST=mysql  
   DB_PORT=3306  
   DB_DATABASE=lynx  
   DB_USERNAME=sail  
   # !!! 强烈建议修改为一个更复杂的随机密码 !!!  
   DB_PASSWORD=password

   REDIS_HOST=redis  
   REDIS_PASSWORD=null  
   REDIS_PORT=6379
   ```
4. 保存并退出。

### **步骤 3：构建并启动应用容器**

1. 在项目根目录 (/var/www/lynx) 下，使用 docker-compose.internet.yml 文件执行构建命令：  
   ```sh
   sudo docker compose -f docker-compose.internet.yml up -d --build
   ```
2. **执行 Laravel 生产环境初始化命令 (顺序很重要)**:  
   * **安装 Composer 后端依赖**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app composer install --no-dev --optimize-autoloader
      ```
   * **生成 APP_KEY**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app php artisan key:generate
      ```
   * **安装 NPM 前端依赖**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app npm install
      ```
   * **构建前端生产资源**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app npm run build
      ```
   * **检查并删除 hot 文件**:  
      ```sh
      sudo rm -f public/hot
      ```
   * **创建存储链接**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app php artisan storage:link
      ```
   * **发布 Filament 核心资产**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app php artisan filament:assets
      ```
   * **运行数据库迁移**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app php artisan migrate --force
      ```
   * **优化生产环境缓存**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app php artisan optimize
      ```
   * **修复目录权限 (最后一步)**:  
      ```sh
      sudo docker compose -f docker-compose.internet.yml exec app chown -R www-data:www-data storage bootstrap/cache
      ```
## **第四阶段：配置反向代理与 SSL**

1. 打开并登录 NPM 管理后台 (http://123.57.128.170:81)。  
2. 导航到 Hosts -> Proxy Hosts，然后点击 Add Proxy Host 按钮。  
3. **填写 Details 选项卡**:  
   * **Domain Names:** lynx.wkarrow.top  
   * **Scheme:** http  
   * **Forward Hostname / IP:** lynx-internet-nginx  
   * **Forward Port:** 80  
   * **勾选 Block Common Exploits**  
4. **切换到 SSL 选项卡**:  
   * **SSL Certificate:** 选择 Request a new SSL Certificate  
   * **勾选 Force SSL**  
   * **勾选 HTTP/2 Support**  
   * **Email Address for Let's Encrypt:** 输入您自己的邮箱。  
   * **勾选 I Agree to the Let's Encrypt Terms of Service**。  
5. 点击 Save 按钮。

NPM 将自动申请 SSL 证书。几秒钟后，状态应变为绿色 Online。

## **第五阶段：访问与验证**

现在，打开浏览器，访问 [https://lynx.wkarrow.top](https://lynx.wkarrow.top)。您应该能看到安全锁标志和您的应用主页！

### **日常运维**

所有运维命令都应使用 ``-f docker-compose.internet.yml`` 参数。

* **启动服务:** ``sudo docker compose -f docker-compose.internet.yml up -d `` 
* **停止服务:** ``sudo docker compose -f docker-compose.internet.yml down  ``
* **更新代码后重新部署:**  
   ```sh
   cd /var/www/lynx  
   sudo git pull  
   sudo docker compose -f docker-compose.internet.yml up -d --build  
   # ... 根据需要运行其他初始化命令 ...  
   sudo docker compose -f docker-compose.internet.yml exec app php artisan optimize:clear  
   sudo docker compose -f docker-compose.internet.yml exec app php artisan optimize  
   ```