# **“土豆食堂”项目阿里云服务器生产环境部署手册**

本文档将指导您如何将 “土豆食堂” (Lynx) Laravel 项目成功部署到阿里云 Ubuntu 24.04 服务器上，并配置 wkarrow.top 域名及自动续期的 Let's Encrypt SSL 证书，实现安全的 HTTPS 访问。

**部署信息:**

* **云服务器:** 阿里云 Ubuntu Server 24.04  
* **公网 IP:** 123.57.128.170  
* **根域名:** wkarrow.top  
* **应用子域名:** lynx.wkarrow.top (我们将使用此子域名作为示例)  
* **核心工具:** Docker Engine, Nginx Proxy Manager

## **第一阶段：域名解析与服务器准备**

在操作服务器之前，必须先完成域名的 DNS 解析和服务器防火墙配置。

### **步骤 1：配置域名解析**

1. 登录您的域名提供商（如阿里云）的 DNS 解析控制台。  
2. 找到您的域名 wkarrow.top，进入解析设置页面。  
3. 添加一条新的 **A 记录**：  
   * **记录类型:** A  
   * **主机记录:** lynx (这代表 lynx.wkarrow.top)  
   * **解析线路:** 默认  
   * **记录值:** 123.57.128.170 (您的服务器公网 IP)  
   * **TTL:** 默认 (例如 10 分钟)  
4. 保存记录。解析通常需要几分钟到十几分钟生效。

### **步骤 2：配置阿里云服务器安全组**

为确保外部流量可以访问我们的服务，需要放行必要的端口。

1. 登录阿里云 ECS 控制台。  
2. 找到您的服务器实例，进入“安全组”配置页面。  
3. 确保您的安全组入方向规则中，已添加以下三条：  
   * **端口 80/80**: 用于 Let's Encrypt 的 HTTP 验证。  
   * **端口 443/443**: 用于公众通过 HTTPS 访问您的应用。  
   * **端口 81/81**: 用于访问 Nginx Proxy Manager 的管理后台。  
   * **端口 22/22**: 用于您通过 SSH 连接服务器 (通常默认已开启)。

### **步骤 3：安装必要的软件**

通过 SSH 登录您的服务器，并执行以下命令。

1. **安装 Git** (用于拉取代码):  
   sudo apt update  
   sudo apt install git \-y

2. **安装 Docker Compose 插件** (Docker Engine 官方推荐):  
   sudo apt install docker-compose-plugin \-y

   验证安装成功 (应能看到版本号):  
   docker compose version

### **步骤 4：配置 Docker Hub 加速镜像 (国内服务器推荐)**

1. 创建或修改 Docker 的配置文件：  
   sudo mkdir \-p /etc/docker  
   sudo nano /etc/docker/daemon.json

2. 将以下内容复制并粘贴到文件中：  
   {  
     "registry-mirrors": \["\[https://docker.m.daocloud.io\](https://docker.m.daocloud.io)"\]  
   }

3. 保存并退出 (Ctrl+X, Y, Enter)。  
4. 重启 Docker 服务以使配置生效：  
   sudo systemctl daemon-reload  
   sudo systemctl restart docker

## **第二阶段：部署 Nginx Proxy Manager (NPM)**

1. 在服务器上，为 NPM 创建一个专用的工作目录：  
   sudo mkdir \-p /opt/npm/data  
   sudo mkdir /opt/npm/letsencrypt

2. 进入该目录并创建一个 docker-compose.yml 文件：  
   cd /opt/npm  
   sudo nano docker-compose.yml

3. 将我们提供的 npm-docker-compose.yml 文件中的所有内容复制并粘贴到这个新文件中，然后保存退出。  
4. 启动 Nginx Proxy Manager:  
   sudo docker compose up \-d

5. **初始化 NPM**：  
   * 打开浏览器，访问 http://123.57.128.170:81。  
   * 使用默认账户首次登录 (Email: admin@example.com, Password: changeme)，并立即修改密码。

## **第三阶段：在服务器上部署项目**

### **步骤 1：获取项目代码**

1. 在服务器上，选择一个位置存放您的项目代码，例如 /var/www：  
   sudo mkdir \-p /var/www  
   cd /var/www

2. 从您的 Git 仓库克隆项目代码：  
   sudo git clone \[https://github.com/NightingaleWK/lynx.git\](https://github.com/NightingaleWK/lynx.git)  
   cd lynx

### **步骤 2：创建并配置 .env 文件**

1. 复制示例文件：  
   sudo cp .env.example .env

2. 编辑 .env 文件：  
   sudo nano .env

3. **进行以下关键修改**：  
   APP\_NAME=Lynx  
   APP\_ENV=production  
   APP\_DEBUG=false  
   APP\_URL=\[https://lynx.wkarrow.top\](https://lynx.wkarrow.top)

   \# 留空，后续命令生成  
   APP\_KEY=

   DB\_CONNECTION=mysql  
   \# 必须是 docker-compose.internet.yml 中定义的服务名  
   DB\_HOST=mysql  
   DB\_PORT=3306  
   DB\_DATABASE=lynx  
   DB\_USERNAME=sail  
   \# \!\!\! 强烈建议修改为一个更复杂的随机密码 \!\!\!  
   DB\_PASSWORD=password

   REDIS\_HOST=redis  
   REDIS\_PASSWORD=null  
   REDIS\_PORT=6379

4. 保存并退出。

### **步骤 3：构建并启动应用容器**

1. 在项目根目录 (/var/www/lynx) 下，使用 docker-compose.internet.yml 文件执行构建命令：  
   sudo docker compose \-f docker-compose.internet.yml up \-d \--build

   *首次构建会花费一些时间，请耐心等待。*  
2. **执行 Laravel 初始化命令**:  
   * 生成 APP\_KEY:  
     sudo docker compose \-f docker-compose.internet.yml exec app php artisan key:generate

   * 运行数据库迁移:  
     sudo docker compose \-f docker-compose.internet.yml exec app php artisan migrate \--force

   * **修复目录权限 (非常重要)**:  
     sudo docker compose \-f docker-compose.internet.yml exec app chown \-R www-data:www-data storage bootstrap/cache

## **第四阶段：配置反向代理与 SSL**

1. 打开并登录 NPM 管理后台 (http://123.57.128.170:81)。  
2. 导航到 Hosts \-\> Proxy Hosts，然后点击 Add Proxy Host 按钮。  
3. **填写 Details 选项卡**:  
   * **Domain Names:** lynx.wkarrow.top  
   * **Scheme:** http  
   * **Forward Hostname / IP:** lynx-internet-nginx (这是您 docker-compose.internet.yml 中 Nginx 服务的容器名称)  
   * **Forward Port:** 80  
   * **勾选 Block Common Exploits**  
4. **切换到 SSL 选项卡**:  
   * **SSL Certificate:** 选择 Request a new SSL Certificate  
   * **勾选 Force SSL**  
   * **勾选 HTTP/2 Support**  
   * **Email Address for Let's Encrypt:** 输入您自己的邮箱。  
   * **勾选 I Agree to the Let's Encrypt Terms of Service**。  
5. 点击 Save 按钮。

NPM 将自动申请 SSL 证书。几秒钟后，状态应变为绿色 Online。

## **第五阶段：访问与验证**

现在，打开浏览器，访问 https://lynx.wkarrow.top。您应该能看到安全锁标志和您的应用主页！

### **日常运维**

所有运维命令都应使用 \-f docker-compose.internet.yml 参数。

* **启动服务:** sudo docker compose \-f docker-compose.internet.yml up \-d  
* **停止服务:** sudo docker compose \-f docker-compose.internet.yml down  
* **更新代码后重新部署:**  
  cd /var/www/lynx  
  sudo git pull  
  sudo docker compose \-f docker-compose.internet.yml up \-d \--build  
  \# 如果需要  
  \# sudo docker compose \-f docker-compose.internet.yml exec app php artisan migrate \--force  
  \# sudo docker compose \-f docker-compose.internet.yml exec app php artisan optimize:clear  
